<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PMC Quiz</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<style>
  :root{
    --bg:#f6f7fb; --card:#ffffff; --border:#d9dee7; --muted:#64748b; --text:#0f172a;
    --accent:#0ea5e9; --accent-d:#0284c7;
    --ok:#16a34a; --bad:#ef4444; --chip:#f1f5f9; --tag:#0ea5e933;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,"Noto Sans","PingFang SC","Microsoft YaHei",sans-serif;
    color:var(--text); background:
      radial-gradient(900px 280px at -10% -20%, #38bdf833, transparent 60%),
      radial-gradient(900px 280px at 110% -10%, #a78bfa33, transparent 60%),
      linear-gradient(180deg, #f8fafc, var(--bg) 40%, #eef2f7 100%);
    min-height:100vh; display:flex; align-items:flex-start; justify-content:center; padding:28px 12px;
  }
  .card{width:100%; max-width:1080px; background:var(--card); border:1px solid var(--border); border-radius:16px; padding:18px; box-shadow:0 10px 30px #0b12200f;}
  h1,h2,h3{margin:0 0 10px}

  #welcome,#menu,#quiz,#finish,#history{margin:6px 0}
  #menu,#quiz,#finish,#history{display:none}

  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .btn{padding:10px 14px; border:1px solid var(--border); border-radius:12px; background:#f8fafc; color:#0b1220; cursor:pointer; transition:.15s; font-weight:600;}
  .btn:hover{transform:translateY(-1px); box-shadow:0 6px 16px #00000010; border-color:#cbd5e1}
  .btn.accent{background:linear-gradient(180deg, var(--accent), var(--accent-d)); color:#fff; border:none}
  .btn.ghost{background:transparent; border:1px dashed var(--border); color:#64748b}
  input[type="text"],input[type="password"]{width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:#fff; color:#0f172a;}
  input[type="text"]:focus,input[type="password"]:focus{border-color:var(--accent)}

  /* 顶部标签（Chapters / History） */
  #tabs{display:none; gap:8px; margin:0 0 12px}
  .tab{padding:8px 12px; border:1px solid var(--border); border-radius:999px; cursor:pointer; color:#64748b; background:#fff}
  .tab.active{color:#fff; background:linear-gradient(180deg, var(--accent), var(--accent-d)); border:none}

  /* 章节目录样式 */
  .meta{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:8px 0}
  .chip{background:var(--chip); border:1px solid var(--border); color:var(--muted); padding:6px 10px; border-radius:999px; font-size:12px}
  .chapter-card{border:1px solid var(--border); border-radius:14px; padding:12px; background:#fff; margin:10px 0}
  .chapter-title{font-weight:800; margin-bottom:6px}
  .sections-wrap{display:flex; flex-wrap:wrap; gap:8px}
  .sec-btn{position:relative; padding:8px 12px; border:1px solid var(--border); border-radius:12px; background:#f8fafc; cursor:pointer; font-weight:600}
  .sec-btn:hover{transform:translateY(-1px); box-shadow:0 6px 16px #00000010}
  .badge{position:absolute; top:-8px; right:-8px; font-size:11px; padding:3px 6px; border-radius:999px; background:var(--tag); color:#055a7a; border:1px solid #7dd3fc}
  .last{font-size:11px; color:#0369a1; margin-left:6px}

  /* 题卡 & 解释（内联） */
  .question{ text-align:left; margin:16px 0; padding:16px; border:1px solid var(--border); border-radius:14px; background:#fff}
  .option-label{ display:block; margin:8px 0; cursor:pointer; line-height:1.45}
  .option-label input{ transform:scale(1.15); margin-right:10px; vertical-align:middle}
  .feedback{ font-weight:700; margin:10px 0 6px}
  .feedback.ok{ color:var(--ok)} .feedback.bad{ color:var(--bad)}
  .explain{ margin:8px 0; padding:10px 12px; background:#f8fafc; border:1px solid var(--border); border-radius:10px}
  img{ max-width:100%; margin:10px 0; border:1px solid var(--border); border-radius:12px}

  progress{ width:100%; height:14px; border:none; background:#eef2f7; border-radius:999px; overflow:hidden}
  progress::-webkit-progress-bar{ background:#eef2f7}
  progress::-webkit-progress-value{ background:linear-gradient(90deg, var(--accent), #a78bfa)}
  #score{font-weight:800} #deltaTag{font-weight:900; margin-left:8px}

  #trialBanner{margin-top:8px} .trial{ padding:10px; border-radius:12px; border:1px solid var(--border); background:#fff; color:#0b1220; display:none}
  .trial strong{ color:var(--accent)} .hint{font-size:12px; color:#64748b}

  /* 历史表 */
  table{width:100%; border-collapse:collapse; font-size:14px}
  th,td{border-bottom:1px solid var(--border); padding:8px 6px; text-align:left}
  th{color:#334155; background:#f8fafc}
  .num{text-align:right} .muted{color:var(--muted)}

  /* 作答页固定返回按钮 */
  #backFloat{position:sticky; top:0; z-index:20; display:none; margin:-6px 0 8px; padding:8px 12px; background:#ffffffcc; backdrop-filter:saturate(180%) blur(6px); border:1px solid var(--border); border-radius:10px;}
</style>
</head>
<body>
  <div class="card">
    <!-- 顶部标签（登录后显示；作答时隐藏） -->
    <div id="tabs">
      <div id="tabMenu" class="tab active">Chapters</div>
      <div id="tabHistory" class="tab">History</div>
    </div>

    <!-- 登录 -->
    <div id="welcome">
      <h2>Sign in</h2>
      <p class="hint">每个账号都有自己的密码；或使用 <code>testing</code> 开启 5 分钟试用。</p>
      <form id="loginForm" autocomplete="on" onsubmit="return false;">
        <div class="row" style="gap:12px;">
          <div style="flex:1 1 280px">
            <label class="hint">Name</label>
            <input type="text" id="username" placeholder="Your name" autocomplete="username"/>
          </div>
          <div style="flex:1 1 280px">
            <label class="hint">Password</label>
            <input type="password" id="accessCode" placeholder="Account password" autocomplete="current-password"/>
          </div>
        </div>
        <div id="trialBanner" class="trial"></div>
        <div class="row" style="margin-top:10px">
          <button id="startBtn" class="btn accent" type="submit">Start</button>
          <!-- 清理按钮按你的需求移除 -->
        </div>
      </form>
    </div>

    <!-- 首页：所有 Chapter + Section 一次展开 -->
    <div id="menu">
      <div class="meta">
        <span class="chip" id="userChip">User</span>
        <span class="chip" id="timerChip">00:00</span>
      </div>
      <h2>Select Section</h2>
      <div id="directory"></div>
    </div>

    <!-- 作答页 -->
    <div id="quiz">
      <div id="backFloat">
        <button id="btnBackSectionsTop" class="btn">← Back to Chapters</button>
      </div>
      <div class="meta">
        <span class="chip" id="userChip2">User</span>
        <span class="chip" id="timerChip2">00:00</span>
      </div>
      <h3 id="quiz-title"></h3>
      <div class="row" style="justify-content:space-between; margin:8px 0">
        <div id="score">Score: 0 <span id="deltaTag"></span></div>
        <div id="remaining">Remaining: 0</div>
      </div>
      <progress id="progress" value="0" max="0"></progress>
      <div id="question-area"></div>
    </div>

    <!-- 完成 -->
    <div id="finish">
      <h3 id="finish-msg"></h3>
      <p id="stats"></p>
      <div id="controls" class="row"></div>
    </div>

    <!-- 历史成绩（右侧带过滤框） -->
    <div id="history">
      <div class="row" style="justify-content:space-between;">
        <h3 style="margin:0">History</h3>
        <div class="row">
          <input id="historyFilter" type="text" placeholder="Filter by name…" style="padding:8px 10px;border:1px solid var(--border);border-radius:10px"/>
          <button id="btnRefresh" class="btn">Refresh</button>
          <button id="btnBackChapters2" class="btn ghost">Back to Chapters</button>
        </div>
      </div>
      <div class="row" id="summaryRow" style="gap:8px; margin:8px 0"></div>
      <div style="overflow:auto; max-height:50vh; border:1px solid var(--border); border-radius:12px; padding:8px;">
        <table id="historyTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>User</th>
              <th>Quiz/Section</th>
              <th class="num">Score</th>
              <th class="num">Correct</th>
              <th class="num">Wrong</th>
              <th class="num">Duration (s)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 提交到 GAS -->
  <iframe name="postFrame" style="display:none;"></iframe>
  <form id="postForm"
        action="https://script.google.com/macros/s/AKfycbyek_JoRdNny8wiHO_nOyiNJV2Gt2qoVjiJ3rhFZu0BkbWYflpVXYiE-_Gl7xHQROM/exec"
        method="post" target="postFrame" style="display:none;">
    <input name="quizId"/><input name="name"/><input name="score"/>
    <input name="correct"/><input name="wrong"/><input name="time"/>
  </form>

<script>
(function(){
  'use strict';

  /* ====== 历史成绩数据源（锁定 CSV，避免 403） ====== */
  const HISTORY_PRIMARY_URL  = 'https://docs.google.com/spreadsheets/d/1ekSsHOISi1AevA637qfSjCoNb6BiN7e7KlcPYJ6WPQI/export?format=csv&gid=0';
  const HISTORY_FALLBACK_CSV = '';

  /* 其他配置 */
  const TRIAL_CODE = 'testing';
  const TRIAL_MINUTES = 5;
  const HISTORY_LIMIT = 200; // 拉多一点，方便统计每个 section 的历史
  const MAX_OPTS=15;

  const LS_SESSION='pmc_session_until', LS_TRIAL='pmc_trial_until', LS_NAME='pmc_user_name';

  /* 状态 */
  let user='', accounts=null;
  let chapters=[], grouped={};
  let chapterKey, sectionKey, labelKey, sheetKey;
  let currentChapter='', currentRow=null;
  let qs=[], queue=[], score=0, correct=0, wrong=0;
  let chapterStart=0, sessionUntil=0, isTrial=false, timerTick=null;

  let historyCache=[];                // 全部历史（未筛人）
  let historyByQuizId=new Map();      // quizId => [{...}, ...]
  let historyReady=false;

  /* DOM */
  const $=(id)=>document.getElementById(id);
  const tabs=$('tabs'), tabMenu=$('tabMenu'), tabHistory=$('tabHistory');
  const elWelcome=$('welcome'), elMenu=$('menu'), elQuiz=$('quiz'), elFinish=$('finish'), elHistory=$('history');
  const elDir=$('directory');
  const elQuestionA=$('question-area'), elProgress=$('progress');
  const elScore=$('score'), elDelta=$('deltaTag'), elRemain=$('remaining'), elTitle=$('quiz-title');
  const elUserChip=$('userChip'), elUserChip2=$('userChip2');
  const elTimerChip=$('timerChip'), elTimerChip2=$('timerChip2'), elTrial=$('trialBanner');
  const historyTable=$('historyTable').querySelector('tbody'), summaryRow=$('summaryRow');

  /* Tabs 显隐 & 绑定 */
  function showTabs(show){ tabs.style.display = show?'flex':'none'; }
  function setTab(active){
    ['menu','history'].forEach(id=>$(id).style.display='none');
    [tabMenu,tabHistory].forEach(t=>t.classList.remove('active'));
    if(active==='menu'){ tabMenu.classList.add('active'); elMenu.style.display='block'; }
    if(active==='history'){ tabHistory.classList.add('active'); elHistory.style.display='block'; }
  }
  tabMenu.onclick=()=>{ showTabs(true); setTab('menu'); };
  tabHistory.onclick=()=> loadHistory(true);
  $('btnBackChapters2').onclick=()=>{ setTab('menu'); showTabs(true); };
  $('btnBackSectionsTop').onclick=()=>{ elQuiz.style.display='none'; setTab('menu'); showTabs(true); window.scrollTo({top:0,behavior:'smooth'}); };

  /* 工具 */
  const now=()=>Date.now();
  const fmtTime=(ms)=>{let s=Math.max(0,Math.floor(ms/1000)); const m=Math.floor(s/60); s%=60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;};
  const readUntil=(k)=>{const raw=localStorage.getItem(k); return raw?parseInt(raw,10):0;};
  const writeUntil=(k,ts)=>{if(ts){localStorage.setItem(k,String(ts));}else{localStorage.removeItem(k);}};
  const shuffle=(arr)=>{for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];} return arr;};

  function startTicker(){
    stopTicker();
    timerTick=setInterval(()=>{
      const elapsed=now()-chapterStart;
      elTimerChip.textContent=fmtTime(elapsed);
      elTimerChip2.textContent=fmtTime(elapsed);
      if(isTrial){
        const left=sessionUntil-now();
        if(left<=0){ alert('Trial expired. Returning to sign in.'); endSession(); }
        else{ elTrial.style.display='block'; elTrial.innerHTML=`试用模式：剩余 <strong>${fmtTime(left)}</strong>`; }
      }
    },500);
  }
  function stopTicker(){ if(timerTick){clearInterval(timerTick); timerTick=null;} }
  function endSession(){
    writeUntil(LS_SESSION,0); writeUntil(LS_TRIAL,0);
    isTrial=false; stopTicker();
    elQuiz.style.display='none'; elFinish.style.display='none';
    showTabs(false);
    elWelcome.style.display='block'; elTrial.style.display='none';
  }
  (function gate(){
    sessionUntil=readUntil(LS_SESSION);
    if(sessionUntil>now()){
      isTrial=(readUntil(LS_TRIAL)===sessionUntil);
      const savedName=localStorage.getItem(LS_NAME)||''; if(savedName) $('username').value=savedName;
      elTrial.style.display=isTrial?'block':'none';
    } else endSession();
  })();

  /* 账户 */
  function normalizeKeys(row){const m={}; Object.keys(row).forEach(k=>m[String(k||'').trim().toLowerCase()]=k); return m;}
  function field(row,map,keys){for(const k of keys){if(map[k]!=null){const v=row[map[k]]; if(v!=null && String(v).trim()!=='') return String(v).trim();}} return '';}
  function loadAccounts(cb){
    if(accounts){cb(); return;}
    Papa.parse('password.csv',{download:true,header:true,skipEmptyLines:true,complete:(res)=>{
      accounts = res.data.map(r=>{const m=normalizeKeys(r); return {name:field(r,m,['name','account','user']), password:field(r,m,['password','pass']), active:field(r,m,['active'])||'1'};})
        .filter(x=>x.name && x.password);
      if(!accounts.length) alert('password.csv 为空或缺少 name/password 列');
      cb();
    }, error:()=>alert('找不到 password.csv 或无法读取')});
  }
  const findAcc=(nm)=>{const l=nm.toLowerCase(); return (accounts||[]).find(a=>a.name.toLowerCase()===l)||null;};

  /* 登录 */
  $('loginForm').addEventListener('submit',function(){
    const nm=$('username').value.trim(), pwd=$('accessCode').value.trim();
    if(!nm) return alert('Please enter your name');
    if(!pwd) return alert('Password is required');

    const afterLogin = ()=>{
      elUserChip.textContent=`User: ${user}`;
      elUserChip2.textContent=`User: ${user}`;
      elWelcome.style.display='none';
      showTabs(true); setTab('menu');
      loadChapters();             // 构建目录
      loadHistory(false);         // 抓历史（用于目录徽章）
      startTicker();
    };

    if(pwd===TRIAL_CODE){
      const ts=now(); user=nm; sessionUntil=ts+TRIAL_MINUTES*60*1000; isTrial=true;
      writeUntil(LS_SESSION,sessionUntil); writeUntil(LS_TRIAL,sessionUntil); localStorage.setItem(LS_NAME,user);
      afterLogin(); return;
    }

    loadAccounts(()=>{
      const acc=findAcc(nm);
      if(!acc) return alert('Account not found');
      if(String(acc.active).trim()==='0') return alert('This account is disabled');
      if(pwd!==acc.password) return alert('Invalid password');
      const ts=now(); user=acc.name; isTrial=false; sessionUntil=ts+24*60*60*1000;
      writeUntil(LS_SESSION,sessionUntil); writeUntil(LS_TRIAL,0); localStorage.setItem(LS_NAME,user);
      afterLogin();
    });
  });

  /* 载入 Chapters，并在首页把所有 Sections 展开 */
  function loadChapters(){
    Papa.parse('Chapters.csv',{download:true,header:true,skipEmptyLines:true,complete:(res)=>{
      chapters = res.data.map(raw=>{ const r={}; Object.entries(raw).forEach(([k,v])=>{ r[k.trim()]= typeof v==='string'? v.trim(): v; }); return r; });
      if(!chapters.length){ alert('Check Chapters.csv file'); return; }
      const keys=Object.keys(chapters[0]);
      chapterKey = keys.find(k=>k.toLowerCase()==='chapter');
      sectionKey = keys.find(k=>k.toLowerCase()==='section');
      labelKey   = keys.find(k=>k.toLowerCase()==='label');
      sheetKey   = keys.find(k=>k.toLowerCase()==='sheet');
      if(!chapterKey||!sectionKey||!labelKey||!sheetKey){ alert('Chapters.csv requires: chapter, section, label, sheet'); return; }

      grouped={}; chapters.forEach(r=>{ const c=r[chapterKey]; (grouped[c]||(grouped[c]=[])).push(r); });
      // 按 chapter 渲染目录
      buildDirectory();
      elMenu.style.display='block';
    }, error:()=>alert('无法读取 Chapters.csv')});
  }

  function buildDirectory(){
    // 统计当前用户的历史：quizId => {count,lastScore}
    const stats = new Map();
    const nm = (user||'').trim().toLowerCase();
    (historyCache||[]).forEach(r=>{
      const rawName = String(r.rawName||'').trim().toLowerCase();
      if(!rawName || rawName!==nm) return;
      const qid = String(r.quiz||r.quizId||'').trim();
      if(!qid) return;
      const obj = stats.get(qid) || {count:0,lastScore:null};
      obj.count += 1;
      if(typeof r.score==='number') obj.lastScore = r.score;
      stats.set(qid,obj);
    });

    elDir.innerHTML='';
    Object.keys(grouped).forEach(chap=>{
      const card = document.createElement('div'); card.className='chapter-card';
      const h = document.createElement('div'); h.className='chapter-title'; h.textContent = chap;
      card.appendChild(h);

      const wrap = document.createElement('div'); wrap.className='sections-wrap';
      const list = grouped[chap].slice().sort((a,b)=> String(a[sectionKey]).localeCompare(String(b[sectionKey]), undefined, {numeric:true}));
      list.forEach(row=>{
        const btn = document.createElement('button'); btn.className='sec-btn';
        btn.textContent = `${row[sectionKey]} : ${row[labelKey]}`;
        const qid = `${chap}_${row[sectionKey]}`;
        const st = stats.get(qid);
        if(st){
          const b = document.createElement('span'); b.className='badge'; b.textContent=st.count;
          btn.appendChild(b);
          if(st.lastScore!=null){ const ls=document.createElement('span'); ls.className='last'; ls.textContent=`Last ${st.lastScore}`; btn.appendChild(ls); }
        }
        btn.onclick = ()=> startByRow(chap,row);
        wrap.appendChild(btn);
      });

      card.appendChild(wrap);
      elDir.appendChild(card);
    });
  }

  function startByRow(chap,row){
    currentChapter = chap;
    currentRow = row;

    // 进入作答页
    elMenu.style.display='none';
    tabs.style.display='none';        // 隐藏 Chapters / History
    $('backFloat').style.display='inline-block';
    elQuiz.style.display='block'; elFinish.style.display='none';

    elTitle.textContent = `${currentChapter} – ${row[sectionKey]}: ${row[labelKey]}`;
    score=correct=wrong=0; chapterStart=now();

    Papa.parse(row[sheetKey],{download:true,header:true,skipEmptyLines:true,complete:(r)=>{
      qs = r.data.map(q=>({...q,attempt:0}));
      queue = shuffle([...qs]);
      updateUI(0); nextQ();
      window.scrollTo({top:0,behavior:'smooth'});
    }, error:()=>alert('无法读取题库 CSV')});
  }

  /* UI / 判分 */
  function updateUI(delta){
    if(delta===0){ elDelta.textContent=''; elDelta.style.color='inherit'; }
    else{ elDelta.textContent=(delta>0?`+${delta}`:`${delta}`); elDelta.style.color=delta>0?'var(--ok)':'var(--bad)'; }
    elScore.childNodes[0].nodeValue = `Score: ${score} `;
    elRemain.textContent=`Remaining: ${queue.length}`;
    elProgress.max=qs.length; elProgress.value=qs.length-queue.length;
  }
  function getExplain(q){
    const keys=['explain','explanation','note','notes'];
    for(const k of keys){ if(q[k] && String(q[k]).trim()) return String(q[k]).trim(); }
    return '';
  }
  function letters(){ return Array.from({length:MAX_OPTS},(_,i)=>String.fromCharCode(65+i)); }

  function nextQ(){
    if(now()>=sessionUntil){ endSession(); return; }
    elQuestionA.innerHTML=''; updateUI(0);
    if(queue.length===0){ return finishSection(); }

    const q = queue.shift();
    const wrap=document.createElement('div'); wrap.className='question';
    const safeQ = String(q.question||'').replace(/\r?\n/g,'<br/>');
    wrap.innerHTML = `<p><strong>${safeQ}</strong></p>`;
    if(q.image){ const img=document.createElement('img'); img.src=String(q.image).replace(/\s*\//g,'/').trim(); wrap.appendChild(img); }

    const opts=document.createElement('div'); opts.className='options';
    if(q.type==='text'){
      opts.innerHTML='<input type="text" id="txtAns" placeholder="Type your answer…"/>';
    }else{
      const ls=letters().filter(l=>q[l]&&String(q[l]).trim());
      shuffle(ls).forEach(l=>{
        const id='opt_'+l+'_'+Math.random().toString(16).slice(2,6);
        const inp=document.createElement('input'); inp.type=(q.type==='checkbox'?'checkbox':'radio'); inp.name='opt'; inp.value=l; inp.id=id;
        const lbl=document.createElement('label'); lbl.className='option-label'; lbl.htmlFor=id; lbl.appendChild(inp);
        let raw=q[l]; if(typeof raw==='string' && /^-?\d+\.0$/.test(raw)) raw=String(parseInt(raw,10));
        lbl.append(' '+raw); opts.appendChild(lbl);
      });
    }
    wrap.appendChild(opts);

    const fb=document.createElement('div'); fb.className='feedback'; wrap.appendChild(fb);

    const sb=document.createElement('button'); sb.className='btn accent'; sb.textContent='Submit';
    sb.onclick=()=>{
      if(now()>=sessionUntil){ endSession(); return; }
      let ua=[];
      if(q.type==='text'){ ua=$('txtAns').value.split(',').map(s=>s.trim()).filter(Boolean); }
      else{ ua=Array.from(wrap.querySelectorAll('input[name="opt"]:checked')).map(i=>i.value); }
      if(!ua.length) return alert('Please select or enter an answer');

      let isC=false;
      if(q.type==='text'){
        const lows=ua.map(s=>s.toLowerCase());
        const ansList=String(q.answer||'').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
        isC=lows.some(v=>ansList.includes(v));
      }else{
        const uaA=ua.map(s=>s.toUpperCase()).sort().join(',');
        const caA=String(q.answer||'').split(',').map(s=>s.trim().toUpperCase()).sort().join(',');
        isC=(uaA===caA);
      }

      const delta=isC?(q.attempt?1:2):(q.attempt?-2:-1);
      score+=delta; if(isC) correct++; else wrong++;

      sb.disabled=true; Array.from(wrap.querySelectorAll('input')).forEach(i=>i.disabled=true);
      fb.className='feedback '+(isC?'ok':'bad');
      let ansTxt='';
      if(!isC){
        ansTxt = String(q.answer||'').split(',').map(letter=>{
          const L=(letter||'').trim().toUpperCase(); return q[L]||L;
        }).join(' / ');
      }
      fb.textContent = isC?`Correct! +${delta}`:`Wrong! ${delta}${ansTxt?`  Answer: ${ansTxt}`:''}`;
      updateUI(delta);

      if(!isC){ q.attempt++; for(let i=0;i<2;i++){ queue.splice(Math.floor(Math.random()*(queue.length+1)),0,{...q}); } }

      const exp=getExplain(q);
      const expDiv=document.createElement('div'); expDiv.className='explain';
      expDiv.innerHTML = exp ? exp.replace(/\r?\n/g,'<br/>') : '<em>No explanation provided for this item.</em>';
      wrap.appendChild(expDiv);

      const nb=document.createElement('button'); nb.className='btn'; nb.textContent='Next Question';
      nb.onclick=()=> nextQ();
      wrap.appendChild(nb);
    };
    wrap.appendChild(sb);
    elQuestionA.appendChild(wrap);
  }

  function finishSection(){
    elQuiz.style.display='none'; $('backFloat').style.display='none'; elFinish.style.display='block';
    $('finish-msg').textContent=`Well done, ${user}!`;
    $('stats').textContent=`Score: ${score}, Correct: ${correct}, Wrong: ${wrong}`;

    // 提交成绩
    const sec=currentRow;
    const f=$('postForm');
    f.quizId.value=`${currentChapter}_${sec[sectionKey]}`;
    f.name.value=user; f.score.value=score; f.correct.value=correct; f.wrong.value=wrong; f.time.value=Math.floor((now()-chapterStart)/1000);
    f.submit();

    // 按钮
    const ctrl=$('controls'); ctrl.innerHTML='';
    const backCh=document.createElement('button'); backCh.className='btn accent'; backCh.textContent='Back to Chapters';
    backCh.onclick=()=>{
      elFinish.style.display='none';
      setTab('menu'); showTabs(true);
      elMenu.style.display='block';
      // 刷新历史 + 目录徽章
      loadHistory(false).then(()=> buildDirectory());
      window.scrollTo({top:0,behavior:'smooth'});
    };
    ctrl.appendChild(backCh);

    const toHistory=document.createElement('button'); toHistory.className='btn'; toHistory.textContent='View History';
    toHistory.onclick=()=>{ elFinish.style.display='none'; showTabs(true); loadHistory(true); };
    ctrl.appendChild(toHistory);
  }

  /* ===== 历史成绩（CSV 读取 + 放宽匹配） ===== */
  $('btnRefresh').onclick=()=> loadHistory(true);

  async function loadHistory(show=false){
    if(!user){ return; }
    if(show){ setTab('history'); }
    historyTable.innerHTML=`<tr><td colspan="7" class="muted">Loading...</td></tr>`; summaryRow.innerHTML='';

    const tryUrls=[];
    if(HISTORY_PRIMARY_URL) tryUrls.push(HISTORY_PRIMARY_URL);
    else if(HISTORY_FALLBACK_CSV) tryUrls.push(HISTORY_FALLBACK_CSV);
    if(!tryUrls.length){ tabHistory.style.display='none'; if(show) setTab('menu'); return; }

    let rows=null;
    for(const url of tryUrls){
      try{
        const txt = await fetch(url,{cache:'no-store'}).then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.text(); });
        rows = await new Promise(res=>Papa.parse(txt,{header:true,skipEmptyLines:true,complete:r=>res(r.data)}));
        break;
      }catch(_){}
    }
    if(!rows){ tabHistory.style.display='none'; if(show) setTab('menu'); return; }

    // 映射列
    const normKey = k => String(k||'').trim().toLowerCase();
    const picker = row => {
      const m={}; Object.keys(row).forEach(k=> m[normKey(k)] = k );
      const pick = (...cands)=> { for(const c of cands){ if(m[c]!=null) return m[c]; } return null; };
      return {
        nameKey: pick('name','user','account','student','nama','participant'),
        quizKey: pick('quizid','quiz'),
        scoreKey: pick('score','mark','marks'),
        cKey: pick('correct','right'),
        wKey: pick('wrong','incorrect'),
        tKey: pick('time','duration','seconds','timesec'),
        tsKey: pick('timestamp','date','datetime','time')
      };
    };

    historyCache = rows.map(r=>{
      const p = picker(r);
      return {
        rawName: p.nameKey ? String(r[p.nameKey]||'') : '',
        quiz:    p.quizKey ? String(r[p.quizKey]||'') : '',
        score:   p.scoreKey!=null ? Number(r[p.scoreKey]||0) : null,
        correct: p.cKey!=null ? Number(r[p.cKey]||0) : null,
        wrong:   p.wKey!=null ? Number(r[p.wKey]||0) : null,
        duration:p.tKey!=null ? Number(r[p.tKey]||0) : null,
        date:    p.tsKey ? String(r[p.tsKey]||'') : ''
      };
    });

    // 生成 quizId -> rows 映射，供目录徽章用
    historyByQuizId = new Map();
    historyCache.forEach(r=>{
      const arr = historyByQuizId.get(r.quiz) || [];
      arr.push(r); historyByQuizId.set(r.quiz, arr);
    });
    historyReady = true;

    // 渲染 History 页
    renderHistory(user);

    // 如果在首页，刷新目录徽章
    if(!show){ buildDirectory(); }
  }

  function renderHistory(nameFilter){
    const tbody = historyTable;
    const norm = s => String(s||'').trim().toLowerCase();
    const all = historyCache.filter(r => r.rawName && r.rawName.trim()!=='');
    let out = all.filter(r => norm(r.rawName) === norm(nameFilter));
    if(out.length===0 && nameFilter){ out = all.filter(r => norm(r.rawName).includes(norm(nameFilter))); }
    if(out.length===0){ out = all.slice(); }

    out.sort((a,b)=>{
      if(a.date && b.date){ return (new Date(b.date)) - (new Date(a.date)); }
      if(a.score!=null && b.score!=null){ return b.score - a.score; }
      return 0;
    });
    const limited = out.slice(0, HISTORY_LIMIT);

    if(!limited.length){
      tbody.innerHTML = `<tr><td colspan="7" class="muted">No records yet.</td></tr>`;
      summaryRow.innerHTML='';
    }else{
      tbody.innerHTML = limited.map(r=>`
        <tr>
          <td>${r.date||'<span class="muted">—</span>'}</td>
          <td>${(r.rawName||'').trim()||'<span class="muted">—</span>'}</td>
          <td>${r.quiz||'<span class="muted">—</span>'}</td>
          <td class="num">${r.score!=null?r.score:'—'}</td>
          <td class="num">${r.correct!=null?r.correct:'—'}</td>
          <td class="num">${r.wrong!=null?r.wrong:'—'}</td>
          <td class="num">${r.duration!=null?r.duration:'—'}</td>
        </tr>
      `).join('');

      const n=limited.length;
      const scores = limited.map(x=>x.score).filter(Number.isFinite);
      const times  = limited.map(x=>x.duration).filter(Number.isFinite);
      const avg = scores.length ? (scores.reduce((a,b)=>a+b,0)/scores.length).toFixed(2) : '—';
      const max = scores.length ? Math.max(...scores) : '—';
      const last = limited[0];
      summaryRow.innerHTML = `
        <span class="chip">Records: ${n}</span>
        <span class="chip">Avg Score: ${avg}</span>
        <span class="chip">Best: ${max}</span>
        <span class="chip">Last: ${last.score!=null?last.score:'—'}${last.quiz?(' • '+last.quiz):''}</span>
        <span class="chip">Avg Time(s): ${times.length?(Math.round(times.reduce((a,b)=>a+b,0)/times.length)):'—'}</span>
      `;
    }

    const inp = document.getElementById('historyFilter');
    if (inp && !inp._bound){
      inp._bound = true;
      inp.addEventListener('input', e => renderHistory(e.target.value));
      if (!inp.value) inp.value = nameFilter || '';
    }
  }

})();
</script>
</body>
</html>
